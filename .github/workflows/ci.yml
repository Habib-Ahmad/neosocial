name: CI/CD Pipeline

# Triggers:
# 1. Push - runs on any push to any branch
# 2. Pull Request - runs on PRs to main
# 3. Schedule - runs every night at 2 AM UTC
# 4. Manual - can be triggered manually from GitHub Actions tab
on:
  push:
    branches: ['**']
  pull_request:
    branches: [main]
  schedule:
    # Runs at 2:00 AM UTC every day (cron syntax: minute hour day month weekday)
    - cron: '0 2 * * *'
  workflow_dispatch:
    # Allows manual trigger from GitHub Actions UI
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: false
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '20'

jobs:
  # Runs Jest unit tests
  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Run unit tests
        working-directory: ./server
        run: npm test -- --testPathPattern=unit
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}

      - name: Upload unit test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: server/coverage/

  # Runs Jest integration tests
  integration-tests:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Run integration tests
        working-directory: ./server
        run: npm test -- --testPathPattern=integration
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}

      - name: Upload integration test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-results
          path: server/coverage/

  # Runs Playwright E2E tests (UI/API tests)
  e2e-tests:
    name: E2E Tests (UI/API)
    runs-on: ubuntu-latest
    needs: [unit-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install root dependencies
        run: npm ci

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Start backend server
        working-directory: ./server
        run: npm run dev &
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}

      - name: Start frontend server
        working-directory: ./client
        run: npm run dev &

      - name: Wait for servers to be ready
        run: |
          echo "Waiting for backend on port 5000..."
          npx wait-on http://localhost:5000 --timeout 60000
          echo "Waiting for frontend on port 8080..."
          npx wait-on http://localhost:8080 --timeout 60000

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-results
          path: |
            playwright-report/
            test-results/

  # Generate test report dashboard
  test-report:
    name: Test Report & Coverage
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Generate coverage report
        working-directory: ./server
        run: npm run test:coverage
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USER: ${{ secrets.NEO4J_USER }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
          TOKEN_SECRET: ${{ secrets.TOKEN_SECRET }}

      - name: Upload coverage reports
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            server/coverage/lcov-report/
            server/coverage/coverage-final.json

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('server/coverage/coverage-final.json', 'utf8'));
            const totals = Object.values(coverage).reduce((acc, file) => {
              Object.keys(file).forEach(key => {
                if (file[key].total !== undefined) {
                  acc[key] = acc[key] || { total: 0, covered: 0 };
                  acc[key].total += file[key].total;
                  acc[key].covered += file[key].covered;
                }
              });
              return acc;
            }, {});
            
            const pct = (key) => ((totals[key].covered / totals[key].total) * 100).toFixed(2);
            
            const comment = `## Test Coverage Report\n\n` +
              `| Metric | Coverage | Status |\n` +
              `|--------|----------|--------|\n` +
              `| Statements | ${pct('s')}% | ${pct('s') >= 70 ? '✅' : '❌'} |\n` +
              `| Branches | ${pct('b')}% | ${pct('b') >= 60 ? '✅' : '❌'} |\n` +
              `| Functions | ${pct('f')}% | ${pct('f') >= 70 ? '✅' : '❌'} |\n` +
              `| Lines | ${pct('l')}% | ${pct('l') >= 70 ? '✅' : '❌'} |\n`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  # Compiles TypeScript and bundles React for production
  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [unit-tests, integration-tests]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Build client
        working-directory: ./client
        run: npm run build

      - name: Install server dependencies
        working-directory: ./server
        run: npm ci

      - name: Build server
        working-directory: ./server
        run: npm run build

  # Triggers deploy webhook
  # Runs on: push to main, scheduled runs, or manual trigger
  # Setup: Add RENDER_DEPLOY_HOOK_SERVER and RENDER_DEPLOY_HOOK_CLIENT secrets in GitHub
  deploy:
    name: Deploy
    runs-on: ubuntu-latest
    needs: [build]
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      github.event_name == 'schedule' ||
      github.event_name == 'workflow_dispatch'

    steps:
      - name: Deploy Server
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_SERVER }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_SERVER }}"
            echo "Server deployment triggered"
          else
            echo "No server deploy hook configured, skipping"
          fi

      - name: Deploy Client
        run: |
          if [ -n "${{ secrets.RENDER_DEPLOY_HOOK_CLIENT }}" ]; then
            curl -X POST "${{ secrets.RENDER_DEPLOY_HOOK_CLIENT }}"
            echo "Client deployment triggered"
          else
            echo "No client deploy hook configured, skipping"
          fi
